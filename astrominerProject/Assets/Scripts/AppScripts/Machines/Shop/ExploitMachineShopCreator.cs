using SBaier.DI;
using UnityEngine;

namespace SBaier.Astrominer
{
	public class ExploitMachineShopCreator : MonoBehaviour, Injectable
	{
		[SerializeField]
		private Transform _hook;

		private ContextPanel<Base> _contextPanel;
		private Pool<ExploitMachineShop, Ship> _pool;
		private Ship _ship;
		private Base _base;

		private ExploitMachineShop _currentShop;

		public void Inject(Resolver resolver)
		{
			_contextPanel = resolver.Resolve<ContextPanel<Base>>();
			_pool = resolver.Resolve<Pool<ExploitMachineShop, Ship>>();
			_ship = resolver.Resolve<Ship>();
			_base = resolver.Resolve<Base>();
		}

		private void OnEnable()
		{
			CheckCreateShop(_ship.Location.Value);
			_ship.Location.OnValueChanged += OnLocationChanged;
			_contextPanel.OnPooling += TryDestructingShop;
		}

		private void OnDisable()
		{
			_ship.Location.OnValueChanged -= OnLocationChanged;
			_contextPanel.OnPooling -= TryDestructingShop;
		}

		private void OnLocationChanged(FlyTarget formervalue, FlyTarget newvalue)
		{
			CheckCreateShop(newvalue);
		}

		private void OnFlyTargetChanged(FlyTarget formervalue, FlyTarget newvalue)
		{
			CheckCreateShop(newvalue);
		}

		private void CheckCreateShop(FlyTarget location)
		{
			bool shallShow = ShallShow(location);
			if (shallShow)
				TryCreatingShop();
			else
				TryDestructingShop();
		}

		private void TryCreatingShop()
		{
			if (_currentShop != null)
				return;
			_currentShop = _pool.Request(_ship);
			_currentShop.transform.SetParent(_hook, false);
		}

		private void TryDestructingShop()
		{
			if (_currentShop == null)
				return;
			_currentShop.InvokeOnPooling();
			_pool.Return(_currentShop);
			_currentShop = null;
		}

		private bool ShallShow(FlyTarget location)
		{
			return location != null && 
			       location.Equals(_base);
		}
	}
}
